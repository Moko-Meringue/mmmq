# Broker

1. Broker는 메시지를 받을 수 있다.
2. Broker에는 MessageDispatcher를 연결할 수 있다.
2. Broker는 메시지를 받으면 적절한 MessageDispatcher에 전달할 수 있다.

# MessageDispatcher

1. MessageDispatcher를 생성할 수 있다.
2. MessageDispatcher에는 하나 이상의 Host를 등록할 수 있다.
3. MessageDispatcher는 내부적으로 Message Queue를 가진다.

# Message

1. 메시지는 Host에게 전달할 데이터를 보관한다.

# Host

1. 특정 Host와 연결되어야 한다.

# Manager

1. Manager는 외부로부터 메시지를 받을 수 있다.
2. Manager는 전달받은 메시지를 브로커에게 전달할 수 있다.
3. Manager는 외부로부터 MessageDispatcher를 등록할 수 있다.
4. Manager는 외부로부터 MessageDispatcher를 삭제할 수 있다.
5. Manager는 MessageDispatcher가 특정 Topic을 구독하도록 할 수 있다.

# MessageSender

1. MessageSender는 특정 host에게 메시지를 전달할 수 있다.
2. MessageSender는 메시지를 전달한 후, Host로부터 응답(ACK/NAK)을 받을 수 있다.

# MessageDispatcher

1. MessageDispatcher Thread를 실행하여 모든 MessageDispatcher의 큐를 확인하고, 큐에 메시지가 존재하면 poll해 Host에게 전달한다.
    - 이 때, MessageDispatcher의 Thread는 MessageDispatcher의 큐를 확인하는 작업과 Host에게 메시지를 전달하는 작업을 분리하여 처리한다.
    - MessageDispatcher는 필드로 ThreadPoolExecutor를 가진다.
2. 클라이언트의 응답(ACK/NAK) 핸들링은 CompletableFuture를 활용하여 비동기로 처리한다.
    - 응답 핸들링이란? (ACK/NAK에 대한 핸들링)
    - ACK? 아무것도 안해
    - NAK? 메시지 큐에 다시 메시지를 놓던지, 다시 보내던지? retry queue에 넣던지

---

# BackLog

- 라이브러리에서 특정 예외 목록이 throw될 수 있음을 클라이언트에게 명시적으로 알려야 한다.
- 클라이언트가 Configuration을 직접 작성하여 restClient에 사용할 errorHandler를 커스텀하는 등의 기능을 제공할 수 있어야 한다.
- 메시지 영속화할 경우 데이터를 바로 poll하면 안됨.
- main config 에 @Profile 제거
- MessageDispatcher 스레드에 대한 헬스 체크 및 재시작!
- MessageDispatcher에서 Host에 대한 헬스 체크.
- Broker에서 메시지 큐 정책 적용.
- Broker에서 메시지 전달 전 영속화.
- LinkedBlockingQueue -> PriorityBlockingQueue 변경 고려.
- MessageDispatcher를 yml 로 구성하는 기능 추가 고려.
- GatewayTest에서 gateway 모듈의 Gateway에 직접 의존하여 신뢰도있는 테스트 작성.
- DLQ 구현(최우선)
- Message 내용으로 Map 또는 Object를 받을 수 있도록 변경
- ListenerRegistration의 스레드 풀을 사용자가 설정할 수 있도록 변경.

1. 사용자가 MessageDispatcher를 빈 등록하는 시나리오
2. MessageDispatcher가 빈으로 등록돼서 @PostCounstruct에서 worker를 실행하는지 확인
